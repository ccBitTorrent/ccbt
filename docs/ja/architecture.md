# アーキテクチャ概要

このドキュメントは、ccBitTorrentのアーキテクチャ、コンポーネント、データフローの技術的な概要を提供します。

## エントリーポイント

ccBitTorrentは、異なるユースケースに対応する複数のエントリーポイントを提供します：

1. **基本CLI (`ccbt`)**：単一トレントダウンロード用のシンプルなコマンドラインインターフェース
   - エントリーポイント：`ccbt/__main__.py:main`
   - 使用方法：`python -m ccbt torrent.torrent` または `python -m ccbt "magnet:..."`

2. **非同期CLI (`ccbt async`)**：完全なセッション管理を備えた高性能非同期インターフェース
   - エントリーポイント：`ccbt/session/async_main.py:main`
   - デーモンモード、複数トレント、高度な機能をサポート

3. **拡張CLI (`btbt`)**：包括的な機能を備えたリッチなコマンドラインインターフェース
   - エントリーポイント：`ccbt/cli/main.py:main`
   - 対話型コマンド、監視、高度な設定を提供

4. **ターミナルダッシュボード (`bitonic`)**：ライブで対話型のターミナルダッシュボード（TUI）
   - エントリーポイント：`ccbt/interface/terminal_dashboard.py:main`
   - トレント、ピア、システムメトリクスのリアルタイム可視化

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────┐
│                    ccBitTorrent Architecture                     │
├─────────────────────────────────────────────────────────────────┤
│  CLI Interface                                                  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │   Basic     │ │ Interactive │ │  Dashboard   │              │
│  │   Commands  │ │     CLI     │ │   (TUI)     │              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
├─────────────────────────────────────────────────────────────────┤
│  Session Management                                             │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │              AsyncSessionManager                           │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │ │
│  │  │   Config    │ │   Events    │ │  Checkpoint │          │ │
│  │  │  Manager    │ │   System    │ │   Manager   │          │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘          │ │
│  └─────────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  Core Components                                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │    Peer     │ │    Piece    │ │    Disk     │              │
│  │  Connection │ │   Manager   │ │     I/O     │              │
│  │  Manager    │ │             │ │   Manager   │              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │   Tracker   │ │     DHT     │ │  Metadata   │              │
│  │   Client    │ │   Manager   │ │  Exchange   │              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
├─────────────────────────────────────────────────────────────────┤
│  Network Layer                                                  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │    TCP      │ │     UDP     │ │   WebRTC    │              │
│  │ Connections │ │  Trackers   │ │ (WebTorrent)│              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
├─────────────────────────────────────────────────────────────────┤
│  Monitoring & Observability                                     │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │   Metrics   │ │   Alerts    │ │   Tracing   │              │
│  │  Collector  │ │   Manager   │ │   Manager   │              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

## コアコンポーネント

### サービスアーキテクチャ

ccBitTorrentは、いくつかのコアサービスを使用するサービス指向アーキテクチャを使用します：

- **PeerService**：ピア接続と通信を管理
  - 実装：`ccbt/services/peer_service.py`
  - ピア接続、帯域幅、ピース統計を追跡
  
- **StorageService**：高性能チャンク書き込みによるファイルシステム操作を管理
  - 実装：`ccbt/services/storage_service.py`
  - ファイル作成、データ読み書き操作を処理
  
- **TrackerService**：トラッカー通信とヘルスモニタリングを管理
  - 実装：`ccbt/services/tracker_service.py`
  - HTTPおよびUDPトラッカーをサポート（BEP 48のscrapeサポート付き）

すべてのサービスは、ライフサイクル管理、ヘルスチェック、状態追跡を提供する基本`Service`クラスを継承します。

**実装：** `ccbt/services/base.py`

### AsyncSessionManager

BitTorrentセッション全体を管理する中央オーケストレーター。2つの実装があります：

1. **`ccbt/session/async_main.py`のAsyncSessionManager**：非同期CLIエントリーポイントで使用され、プロトコルサポート付きで複数のトレントを管理します。

`AsyncSessionManager`クラスは`ccbt/session/async_main.py`の319行目から定義されています。主要な初期化属性には以下が含まれます：

- `config`：設定インスタンス（提供されない場合はグローバル設定を使用）
- `torrents`：トレントIDを`AsyncDownloadManager`インスタンスにマッピングする辞書
- `metrics`：`MetricsCollector`インスタンス（有効な場合、`start()`で初期化）
- `disk_io_manager`：ディスクI/Oマネージャー（`start()`で初期化）
- `security_manager`：セキュリティマネージャー（`start()`で初期化）
- `protocol_manager`：複数のプロトコルを管理する`ProtocolManager`
- `protocols`：アクティブなプロトコルインスタンスのリスト

完全な実装を参照：

```python
--8<-- "ccbt/session/async_main.py:319:374"
```

2. **`ccbt/session/session.py`のAsyncSessionManager**：DHT、キュー管理、NATトラバーサル、scrapeサポートを備えたより包括的な実装。

`ccbt/session/session.py`のより包括的な`AsyncSessionManager`（1317行目から）には、追加のコンポーネントが含まれます：

- `dht_client`：ピア発見用のDHTクライアント
- `peer_service`：ピア接続を管理する`PeerService`インスタンス
- `queue_manager`：優先順位付け用のトレントキューマネージャー
- `nat_manager`：ポートマッピング用のNATトラバーサルマネージャー
- `private_torrents`：プライベートトレントを追跡するセット（BEP 27）
- `scrape_cache`：トラッカーscrape結果のキャッシュ（BEP 48）
- クリーンアップ、メトリクス収集、定期的なscraping用のバックグラウンドタスク

完全な実装を参照：

```python
--8<-- "ccbt/session/session.py:1317:1367"
```

**責任：**
- トレントライフサイクル管理
- `PeerService`を介したピア接続調整
- プロトコル管理（`BitTorrentProtocol`、`IPFSProtocol`）
- リソース割り当てと制限
- `EventBus`を介したイベント配信
- チェックポイント管理
- DHTクライアント管理
- トレント優先順位付け用のキュー管理
- `NATManager`を介したNATトラバーサル
- トラッカーscraping（BEP 48）

#### セッションコントローラー（リファクタリング）

保守性を向上させるため、セッションロジックは`ccbt/session/`の下のフォーカスされたコントローラーに段階的に抽出されています：

- `models.py`：`TorrentStatus`列挙型と`SessionContext`
- `types.py`：プロトコル（`DHTClientProtocol`、`TrackerClientProtocol`、`PeerManagerProtocol`、`PieceManagerProtocol`）
- `tasks.py`：バックグラウンドタスク管理用の`TaskSupervisor`
- `checkpointing.py`：保存/読み込みとバッチ処理用の`CheckpointController`
- `discovery.py`：DHT/トラッカー発見と重複排除用の`DiscoveryController`
- `peer_events.py`：コールバック配線用の`PeerEventsBinder`
- `lifecycle.py`：開始/一時停止/再開/停止のシーケンシング用の`LifecycleController`
- `metrics_status.py`：メトリクスとステータス集約ヘルパー
- `adapters.py`：プロトコルの背後で具体的なクライアントを統一する`DHTAdapter`と`TrackerAdapter`

### ピア接続マネージャー

高度なパイプライン処理でピア接続をすべて処理します。`AsyncPeerConnectionManager`は、トレントセッションの個別のピア接続を管理します。

**実装：** `ccbt/peer/async_peer_connection.py`

**機能：**
- 非同期TCP接続
- リクエストパイプライン処理（16-64の未処理リクエスト）
- 適応的ブロックサイズ
- 接続プール
- Choking/unchokingアルゴリズム
- BitTorrentプロトコルハンドシェイク
- 拡張プロトコルサポート（Fast、PEX、DHT、WebSeed、SSL、XET）

### ピースマネージャー

高度なピース選択アルゴリズムを実装します。`AsyncPieceManager`は、ピースのダウンロード、検証、完了追跡を調整します。

**実装：** `ccbt/piece/async_piece_manager.py`

**アルゴリズム：**
- **Rarest-First**：最適なスウォームの健全性
- **Sequential**：ストリーミングメディア用
- **Round-Robin**：シンプルなフォールバック
- **Endgame Mode**：完了のための重複リクエスト
- 部分ダウンロード用のファイル選択サポート

### ディスクI/Oマネージャー

複数の戦略で最適化されたディスク操作。ディスクI/Oシステムは`init_disk_io()`を介して初期化され、セッションマネージャーを通じて管理されます。

**実装：** `ccbt/storage/disk_io.py`

**最適化：**
- ファイル事前割り当て（sparse/full）
- 書き込みバッチ処理とバッファリング
- メモリマッピングI/O
- io_uringサポート（Linux）
- 高性能ストレージ用の直接I/O
- 並列ハッシュ検証
- 再開機能用のチェックポイント管理

## データフロー

### ダウンロードプロセス

```
1. トレント読み込み
   ┌─────────────┐
   │ Torrent File│ ──┐
   │ or Magnet   │   │
   └─────────────┘   │
                     │
2. トラッカーアナウンス│
   ┌─────────────┐   │
   │   Tracker  │ ◄──┘
   │   Client   │
   └─────────────┘
           │
           ▼
3. ピア発見
   ┌─────────────┐
   │    DHT     │
   │   Manager  │
   └─────────────┘
           │
           ▼
4. ピア接続
   ┌─────────────┐
   │    Peer    │
   │ Connection │
   │   Manager  │
   └─────────────┘
           │
           ▼
5. ピース選択
   ┌─────────────┐
   │    Piece    │
   │   Manager   │
   └─────────────┘
           │
           ▼
6. データ転送
   ┌─────────────┐
   │    Disk     │
   │     I/O     │
   │   Manager   │
   └─────────────┘
```

### イベントシステム

システムは疎結合のためのイベント駆動アーキテクチャを使用します。イベントはグローバル`EventBus`を通じて発行され、任意のコンポーネントが購読できます。

**実装：** `ccbt/utils/events.py`

イベントシステムには包括的なイベントタイプが含まれます：

`EventType`列挙型は、ピア、ピース、トレント、トラッカー、DHT、プロトコル、拡張、セキュリティイベントを含むすべてのシステムイベントを定義します。すべてのイベントタイプを含む完全な列挙型：

```python
--8<-- "ccbt/utils/events.py:34:152"
```

イベントは`emit_event()`関数を介してグローバルイベントバスを使用して発行されます：

```python
--8<-- "ccbt/utils/events.py:658:661"
```

## 設定システム

### 階層的設定

設定は、優先順位順に複数のソースから設定を読み込む`ConfigManager`によって管理されます。

**実装：** `ccbt/config/config.py`

`ConfigManager`クラスは、設定の読み込み、検証、ホットリロードを処理します。標準的な場所で設定ファイルを検索し、暗号化されたプロキシパスワードをサポートします。初期化を参照：

```python
--8<-- "ccbt/config/config.py:46:60"
```

**設定ソース（順序）：**
1. デフォルト値（Pydanticモデルから）
2. 設定ファイル（現在のディレクトリの`ccbt.toml`、`~/.config/ccbt/ccbt.toml`、または`~/.ccbt.toml`）
3. 環境変数（`CCBT_*`）
4. CLI引数
5. トレントごとのオーバーライド

### ホットリロード

`ConfigManager`は、アプリケーションを再起動せずに設定ファイルのホットリロードをサポートします。設定ファイルが検出されると、ホットリロードが自動的に開始されます。

## 監視と可観測性

### メトリクス収集

メトリクス収集は`init_metrics()`を介して初期化され、Prometheus互換のメトリクスを提供します。

**実装：** `ccbt/monitoring/metrics_collector.py`

メトリクスはセッションマネージャーの`start()`メソッドで初期化され、設定で有効になっている場合は`session.metrics`を介してアクセスできます。

### アラートシステム

アラートシステムは、さまざまなシステム条件に対するルールベースのアラートを提供します。

**実装：** `ccbt/monitoring/alert_manager.py`

### トレーシング

パフォーマンス分析とデバッグ用の分散トレーシングサポート。

**実装：** `ccbt/monitoring/tracing.py`

## セキュリティ機能

### セキュリティマネージャー

`SecurityManager`は、IPフィルタリング、ピア検証、レート制限、異常検出を含む包括的なセキュリティ機能を提供します。

**実装：** `ccbt/security/security_manager.py`

セキュリティマネージャーはセッションマネージャーの`start()`メソッドで初期化され、設定からIPフィルターを読み込むことができます。

### ピア検証

ピア検証は、ブロックされたIPと疑わしい動作パターンをチェックする`PeerValidator`によって処理されます。

**実装：** `ccbt/security/peer_validator.py`

### レート制限

帯域幅管理のための適応的レート制限は、`RateLimiter`と`AdaptiveLimiter`（MLベース）によって提供されます。

**実装：** `ccbt/security/rate_limiter.py`、`ccbt/ml/adaptive_limiter.py`

## 拡張性

### プラグインシステム

プラグインシステムにより、オプションのプラグインと拡張機能を登録および管理できます。

**実装：** `ccbt/plugins/base.py`

プラグインは`PluginManager`に登録でき、さまざまなシステムイベントのフックを提供します。

### プロトコル拡張

BitTorrentプロトコル拡張は、Fast Extension、PEX、DHT、WebSeed、SSL、XET拡張を処理する`ExtensionManager`によって管理されます。

**実装：** `ccbt/extensions/manager.py`

`ExtensionManager`は、Protocol、SSL、Fast、PEX、DHT拡張を含むすべてのサポートされているBitTorrent拡張を初期化します。各拡張はその機能とステータスで登録されます。初期化ロジックを参照：

```python
--8<-- "ccbt/extensions/manager.py:51:110"
```

### プロトコルマネージャー

`ProtocolManager`は、サーキットブレーカーサポートとパフォーマンス追跡を備えた複数のプロトコル（BitTorrent、IPFS、WebTorrent、XET、Hybrid）を管理します。

**実装：** `ccbt/protocols/base.py`

`ProtocolManager`は、サーキットブレーカーサポート、パフォーマンス追跡、自動イベント発行を備えた複数のプロトコルを管理します。プロトコルはそのタイプで登録され、統計はプロトコルごとに追跡されます。初期化と登録を参照：

```python
--8<-- "ccbt/protocols/base.py:286:324"
```

## パフォーマンス最適化

### 全体でのAsync/Await

すべてのI/O操作は非同期です：
- ネットワーク操作
- ディスクI/O
- ハッシュ検証
- 設定読み込み

### メモリ管理

- 可能な限りゼロコピーメッセージ処理
- 高スループットシナリオ用のリングバッファ
- メモリマッピングファイルI/O
- 効率的なデータ構造

### 接続プール

接続プールは、TCP接続を効率的に再利用し、接続制限を管理するためにピア接続層に実装されています。

**実装：** `ccbt/peer/connection_pool.py`

## テストアーキテクチャ

### テストカテゴリ

- **ユニットテスト**：個別コンポーネントのテスト
- **統合テスト**：コンポーネント間相互作用のテスト
- **パフォーマンステスト**：ベンチマークとプロファイリング
- **カオステスト**：障害注入と回復力テスト

### テストユーティリティ

テストユーティリティとモックは、ユニット、統合、プロパティ、パフォーマンステスト用に`tests/`ディレクトリで利用できます。

## 将来のアーキテクチャの考慮事項

### スケーラビリティ

- 複数のセッションマネージャーによる水平スケーリング
- 分散ピア発見
- インスタンス間の負荷分散

### クラウド統合

- クラウドストレージバックエンド
- サーバーレスデプロイメントオプション
- コンテナオーケストレーション

### 高度な機能

- ピア選択のための機械学習
- ブロックチェーンベースのピア発見
- **IPFS統合**（実装済み）
- WebTorrent互換性

## IPFSプロトコル統合

### アーキテクチャ概要

IPFSプロトコル統合は、IPFSデーモンを介して分散コンテンツアドレッシングとピアツーピアネットワーキング機能を提供します。

**実装：** `ccbt/protocols/ipfs.py`

### 統合ポイント

```
┌─────────────────────────────────────────────────────────────┐
│                    IPFS Protocol Integration                  │
├─────────────────────────────────────────────────────────────┤
│  Session Manager                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │         AsyncSessionManager                           │  │
│  │  ┌─────────────────────────────────────────────────┐ │  │
│  │  │         ProtocolManager                         │ │  │
│  │  │  ┌──────────────┐  ┌──────────────┐           │ │  │
│  │  │  │ BitTorrent   │  │    IPFS      │           │ │  │
│  │  │  │  Protocol    │  │  Protocol    │           │ │  │
│  │  │  └──────────────┘  └──────────────┘           │ │  │
│  │  └─────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  IPFS Protocol                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   HTTP API   │  │   Pubsub     │  │     DHT      │     │
│  │  Client      │  │  Messaging   │  │  Discovery   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Content    │  │   Gateway    │  │   Pinning    │     │
│  │  Operations  │  │   Fallback   │  │   Manager    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
├─────────────────────────────────────────────────────────────┤
│  IPFS Daemon (External)                                      │
│  ┌───────────────────────────────────────────────────────┐  │
│  │  IPFS Node (libp2p, Bitswap, DHT, Gateway)          │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### プロトコルライフサイクル

1. **初期化**：プロトコルが作成され、`ProtocolManager`に登録されます
2. **接続**：`start()`がHTTP APIを介してIPFSデーモンに接続します
3. **検証**：ノードIDが照会され、接続が検証されます
4. **操作**：コンテンツ操作、ピア接続、メッセージング
5. **クリーンアップ**：`stop()`が切断し、リソースをクリーンアップします

### セッションマネージャー統合

IPFSプロトコルは、設定で有効になっている場合、セッションマネージャーの起動中に自動的に登録されます。プロトコルはプロトコルマネージャーに登録され、IPFSが利用できない場合でもセッション起動を妨げない優雅なエラーハンドリングで開始されます。初期化を参照：

```python
--8<-- "ccbt/session/async_main.py:441:462"
```

### コンテンツアドレッシング

IPFSは、不変のコンテンツアドレッシングにContent Identifiers（CIDs）を使用します：

- **CIDv0**：Base58エンコード、レガシー形式（例：`Qm...`）
- **CIDv1**：Multibaseエンコード、モダン形式（例：`bafybei...`）
- コンテンツはその暗号化ハッシュによってアドレス指定されます
- 同じコンテンツは常に同じCIDを生成します

### トレントからIPFSへの変換

トレントはIPFSコンテンツに変換できます：

1. トレントメタデータがJSONにシリアライズされます
2. メタデータがIPFSに追加され、CIDが生成されます
3. ピースハッシュがブロックとして参照されます
4. 設定されている場合、コンテンツが自動的にピン留めされます

### ピア通信

- **Pubsub**：トピックベースのメッセージング（`/ccbt/peer/{peer_id}`）
- **Multiaddr**：ピアアドレスの標準形式
- **DHT**：ピア発見用の分散ハッシュテーブル
- **メッセージキュー**：信頼性の高い配信のためのピアごとのキュー

### コンテンツ操作

- **Add**：コンテンツがIPFSに追加され、CIDが返されます
- **Get**：CIDによってコンテンツが取得されます
- **Pin**：コンテンツがピン留めされ、ガベージコレクションを防ぎます
- **Unpin**：コンテンツがピン留め解除され、ガベージコレクションされる可能性があります
- **Stats**：コンテンツ統計（サイズ、ブロック、リンク）

### 設定

IPFS設定はメイン`Config`モデルの一部です。IPFS設定の詳細については、設定ドキュメントを参照してください。

### エラーハンドリング

- 接続失敗：指数バックオフによる自動再試行
- タイムアウト：操作ごとの設定可能なタイムアウト
- デーモン利用不可：優雅な劣化、プロトコルは登録されたまま
- コンテンツが見つからない：`None`を返し、警告をログに記録

### パフォーマンスの考慮事項

- **非同期操作**：すべてのIPFS API呼び出しは`asyncio.to_thread`を使用してブロッキングを回避します
- **キャッシング**：発見結果とコンテンツ統計がTTL付きでキャッシュされます
- **ゲートウェイフォールバック**：デーモンが利用できない場合、パブリックゲートウェイが使用されます
- **接続プール**：IPFSデーモンへのHTTP接続を再利用します

### シーケンス図

```
Session Manager          IPFS Protocol          IPFS Daemon
     │                         │                      │
     │  start()                │                      │
     ├────────────────────────>│                      │
     │                         │  connect()           │
     │                         ├─────────────────────>│
     │                         │  id()                │
     │                         ├─────────────────────>│
     │                         │<─────────────────────┤
     │                         │                      │
     │  add_content()           │                      │
     ├────────────────────────>│  add_bytes()         │
     │                         ├─────────────────────>│
     │                         │<─────────────────────┤
     │  <CID>                  │                      │
     │<────────────────────────┤                      │
     │                         │                      │
     │  get_content(CID)       │                      │
     ├────────────────────────>│  cat(CID)            │
     │                         ├─────────────────────>│
     │                         │<─────────────────────┤
     │  <content>               │                      │
     │<────────────────────────┤                      │
     │                         │                      │
     │  stop()                  │                      │
     ├────────────────────────>│  close()             │
     │                         ├─────────────────────>│
     │                         │<─────────────────────┤
     │                         │                      │
```

特定のコンポーネントに関するより詳細な情報については、個別のドキュメントファイルとソースコードを参照してください。

