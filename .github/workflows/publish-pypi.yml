name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: false
        type: string

jobs:
  publish:
    name: publish-to-pypi
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install UV
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install project dependencies
        run: |
          uv sync --dev
      
      - name: Build package with uv
        run: |
          uv build
      
      - name: Verify package files
        run: |
          echo "ðŸ“¦ Built package files:"
          ls -lh dist/
          echo ""
          echo "ðŸ“‹ Package contents:"
          uv run twine check dist/* || echo "âš ï¸  twine not available, skipping check"
      
      - name: Publish to PyPI
        env:
          UV_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -z "$UV_PYPI_TOKEN" ]; then
            echo "âŒ Error: PYPI_API_TOKEN secret is not set"
            echo "Please add your PyPI API token as a GitHub secret named 'PYPI_API_TOKEN'"
            exit 1
          fi
          
          echo "ðŸš€ Publishing to PyPI..."
          uv publish
          
          echo "âœ… Successfully published to PyPI!"
          echo "ðŸ“¦ Package: https://pypi.org/project/ccbt/"
      
      - name: Extract version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Published version: $VERSION"
      
      - name: Verify publication
        run: |
          echo "â³ Waiting 10 seconds for PyPI to propagate..."
          sleep 10
          
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "ðŸ” Verifying package is available on PyPI..."
          
          # Try to check if package is available (non-blocking)
          pip install --upgrade pip || true
          pip index versions ccbt 2>/dev/null | grep -q "$VERSION" && echo "âœ… Version $VERSION found on PyPI!" || echo "âš ï¸  Version may not be immediately available"
      
      - name: Publish summary
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "## âœ… PyPI Publication Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package Links:**" >> $GITHUB_STEP_SUMMARY
          echo "- PyPI: https://pypi.org/project/ccbt/" >> $GITHUB_STEP_SUMMARY
          echo "- Installation: \`uv pip install ccbt==$VERSION\`" >> $GITHUB_STEP_SUMMARY

