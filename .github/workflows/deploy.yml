name: Deploy

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., 0.1.0)'
        required: true
        type: string

jobs:
  deploy-pypi:
    name: deploy-pypi
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write  # For trusted publishing
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install UV
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: |
          uv sync --dev
          uv pip install build twine
      
      - name: Build package
        run: |
          uv run python -m build
      
      - name: Validate package
        run: |
          uv run twine check dist/*
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          print-hash: true
      
      - name: Verify PyPI publication
        run: |
          echo "Waiting 10 seconds for PyPI to propagate..."
          sleep 10
          echo "Package should be available at: https://pypi.org/project/ccbt/"

  create-release-assets:
    name: create-release-assets
    runs-on: ubuntu-latest
    needs: deploy-pypi
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Windows executable
        uses: actions/download-artifact@v4
        with:
          name: windows-executable
          path: dist/
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.whl
            dist/*.tar.gz
            dist/bitonic.exe
          draft: false
          prerelease: false
        continue-on-error: true
      
      - name: Post-release verification
        run: |
          echo "## âœ… Release Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- PyPI package published" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub Release created with assets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify PyPI: https://pypi.org/project/ccbt/" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify Release: https://github.com/ccBittorrent/ccbt/releases" >> $GITHUB_STEP_SUMMARY
          echo "3. Test installation: \`uv pip install ccbt\`" >> $GITHUB_STEP_SUMMARY

