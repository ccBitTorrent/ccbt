name: Version Check

on:
  pull_request:
    branches: [main, dev]
    paths:
      - 'pyproject.toml'
      - 'ccbt/__init__.py'
  push:
    branches: [main, dev]
    paths:
      - 'pyproject.toml'
      - 'ccbt/__init__.py'
  merge_group:
    branches: [dev]

jobs:
  check-version-consistency:
    name: check-version-consistency
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version from pyproject.toml
        id: pyproject_version
        run: |
          VERSION=$(grep -E '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version in pyproject.toml: $VERSION"
      
      - name: Check version in __init__.py (if exists)
        id: init_version
        run: |
          if [ -f ccbt/__init__.py ]; then
            VERSION=$(grep -E '__version__|version' ccbt/__init__.py | head -1 | sed "s/.*['\"]\(.*\)['\"].*/\1/" || echo "")
            if [ -n "$VERSION" ]; then
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "Version in __init__.py: $VERSION"
            else
              echo "No version found in __init__.py"
            fi
          else
            echo "ccbt/__init__.py does not exist"
          fi
        continue-on-error: true
      
      - name: Verify version consistency
        run: |
          PYPROJECT_VERSION="${{ steps.pyproject_version.outputs.version }}"
          INIT_VERSION="${{ steps.init_version.outputs.version }}"
          
          echo "pyproject.toml version: $PYPROJECT_VERSION"
          echo "__init__.py version: $INIT_VERSION"
          
          if [ -n "$INIT_VERSION" ] && [ "$PYPROJECT_VERSION" != "$INIT_VERSION" ]; then
            echo "❌ Version mismatch detected!"
            echo "   pyproject.toml: $PYPROJECT_VERSION"
            echo "   __init__.py: $INIT_VERSION"
            echo ""
            echo "Please ensure both files have the same version."
            exit 1
          fi
          
          echo "✅ Version consistency check passed: $PYPROJECT_VERSION"
      
      - name: Check semantic versioning format
        run: |
          VERSION="${{ steps.pyproject_version.outputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$'; then
            echo "⚠️  Version '$VERSION' may not follow semantic versioning (MAJOR.MINOR.PATCH)"
            echo "   Consider using format like: 0.1.0, 1.2.3, 2.0.0-beta.1"
          else
            echo "✅ Version format is valid: $VERSION"
          fi
        continue-on-error: true
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install packaging
      
      - name: Validate branch-specific version rules
        run: |
          VERSION="${{ steps.pyproject_version.outputs.version }}"
          BRANCH="${{ github.base_ref || github.ref_name }}"
          
          # Parse version
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          
          echo "Branch: $BRANCH"
          echo "Version: $VERSION (Major: $MAJOR, Minor: $MINOR)"
          
          if [ "$BRANCH" = "main" ]; then
            # Main branch: version must be >= 0.1.0
            if [ "$MAJOR" -eq 0 ] && [ "$MINOR" -eq 0 ]; then
              echo "❌ Main branch requires version >= 0.1.0, got $VERSION"
              exit 1
            fi
            echo "✅ Main branch version check passed"
          elif [ "$BRANCH" = "dev" ]; then
            # Dev branch: allow 0.0.1 or any valid semver
            if [ "$MAJOR" -eq 0 ] && [ "$MINOR" -eq 0 ] && [ "$(echo "$VERSION" | cut -d. -f3)" -eq 0 ]; then
              echo "❌ Dev branch version must be > 0.0.0, got $VERSION"
              exit 1
            fi
            echo "✅ Dev branch version check passed"
          fi
      
      - name: Check maintainer permissions for 0.1+ versions on main
        if: github.event_name == 'pull_request' && github.base_ref == 'main'
        run: |
          VERSION="${{ steps.pyproject_version.outputs.version }}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          
          # If version is >= 0.1.0, check if user is maintainer/owner
          if [ "$MAJOR" -gt 0 ] || [ "$MINOR" -ge 1 ]; then
            echo "Version $VERSION is >= 0.1.0, checking maintainer permissions..."
            
            # Get PR author
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"
            echo "PR author: $PR_AUTHOR"
            
            # Check if user has write access (maintainer/owner)
            # This is a basic check - GitHub API would be more accurate
            # For now, we'll just warn and let the merge protection handle it
            echo "⚠️  Version >= 0.1.0 requires maintainer/owner permissions"
            echo "   If you're not a maintainer, please use version 0.0.1 on dev branch"
          fi
      
      - name: Run Python version validation script
        run: |
          python dev/scripts/validate_version.py
      
      - name: Validate changelog
        run: |
          python dev/scripts/validate_changelog.py || {
            echo "⚠️  Changelog validation failed."
            echo "Please ensure dev/CHANGELOG.md is updated with your changes."
            exit 1
          }

